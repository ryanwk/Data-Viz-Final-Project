<!DOCTYPE html>
<meta charset="utf-8">

<head>

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <!-- <script src="//d3js.org/d3.v4.min.js"></script> -->
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.1/crossfilter.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

  <style>

    #title {
  text-align: center;
  padding-bottom: 60px;
  font-size: 30px;
  font-weight: 400;
}

/* .d3-tip {
  line-height: 1.5;
  padding: 8px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 0px;
  text-align: center;
} */

body {
  font-family: 'Open Sans', sans-serif;
  font-size: 12px;
  font-weight: 400;
  background-color: #fff;
  margin-top: 10px;
}


.q0{fill:rgb(255,255,204)}
.q1{fill:rgb(255,237,160)}
.q2{fill:rgb(254,217,118)}
.q3{fill:rgb(254,178,76)}
.q4{fill:rgb(253,141,60)}
.q5{fill:rgb(252,78,42)}
.q6{fill:rgb(227,26,28)}
.q7{fill:rgb(189,0,38)}
.q8{fill:rgb(128,0,38)}

    path {
      stroke: black;
      stroke-width: 1;
      fill: none;
    }

    .axis line {
      stroke: black;
      stroke-width: 30;
      shape-rendering: crispEdges;
    }
    /* .text {
      font-family: 'Open Sans', sans-serif;
      font-size: 30px;
      font-weight: 400;
      stroke: black;
      stroke-width: 2;
    } */

    .yaxis {
      font-family: 'Open Sans', sans-serif;
      font-size: 20px;
      /* font-weight: 400; */
      stroke: black;
      /* stroke-width: 2; */
    }

    .xaxis {
      font-family: 'Open Sans', sans-serif;
      font-size: 20px;
      /* font-weight: 400; */
      stroke: black;
      /* stroke-width: 2; */
    }

* {
  box-sizing: border-box;
}

/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
  padding: 10px;
  height: 100%;
}

/* Clear floats after the columns */
.row:after {
  display: table;
  clear: both;
}

  </style>

</head>


<body>
  <div class="row">

    <div id="methaneMap" class="column">

      <h1 class="title"></h1></br>

      <form>
        <label for="year">Please select a year: </label>
        <input type="range" min=2013 max=2017 step=1 id="year" value=2013 oninput="selected_year.value = year.value">
        <output name="selected_year" id="selected_year">2013</output>
      </form>

    </div>

    <div id="cowChart" class="column">

      <div id="option">
        <input name="updateButton" type="button" value="Update" onclick="updateData()" />
      </div>

      <h1 id="cowChartTitle" class="title"></h1></br>

    </div>
  </div>

  <script>

    // Set the dimensions of the cowChart
    var chartMargin = { top: 30, right: 20, bottom: 30, left: 50 },
      chartWidth = 600 - chartMargin.left - chartMargin.right,
      chartHeight = 420 - chartMargin.top - chartMargin.bottom;

    // Get the data
    d3.csv("data1.csv", function (error, data) {
      data.forEach(function (d) {
        d.value = +d.value;
        return d.value;
      });

      // Scale it
      var x = d3.scale.ordinal()
        .domain(data.map(function (d) { return d.state; }))
        .rangeRoundBands([0, chartWidth], .1);

      var y = d3.scale.linear()
        .domain([0, d3.max(data, function (d) { return d.value; }) * 1.1])
        .range([chartHeight, 0]);

      // Define the axes cowChart
      var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(10);

      var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(10);

      // Adds the svg canvas
      var cowChart = d3.select("#cowChart")
        .append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 960 500")
        .append("g")
        .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")");


      // chart name; made it dynamically change
      var chartTitle = "Milk Cows by State";
      var cowCharttitle = d3.select("#cowChartTitle")
        .text(chartTitle);

      // Scale the range of the data
      // x.domain(d3.extent(data, function (d) { return d.state; }));
      // y.domain([0, d3.max(data, function (d) { return d.value; })]);

      // give the barz some space
      var barPadding = 1;
      // make tha barz
      cowChart.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("width", chartWidth / data.length - barPadding)
        .attr("height", function (d) {
          return d.value;  //Just the data value
        })
        .attr("x", function (data, i) {
          return i * (chartWidth / data.length - barPadding);
        })
        .attr("y", function (data) {
          return chartHeight - data.value;  //Height minus data value
        })
        .attr("fill", function (d) {
          return "rgb(0, 0, " + (d.value * 10) + ")";
        });

      // label barz
      cowChart.selectAll("text")
        .data(data)
        .enter()
        .append("text")
        .text(function (d) {
          return d.value;
        })
        .attr("x", function (d, i) {
          return i * (chartWidth / data.length) + (chartWidth / data.length - barPadding) / 2;
        })
        .attr("y", function (d) {
          return chartHeight - (d.value * 4) + 14;
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", "11px")
        .attr("fill", "black")
        .attr("text-anchor", "middle");

      // put rects linked to data2 in here to build bar chart
      // or go with a line chart and use the following code..
      // Define the line 
      var valueline = d3.svg.line()
        .x(function (d) { return x(d.state); })
        .y(function (d) { return y(d.value); });

      // Add the valueline path.
      cowChart.append("rect")
        .attr("class", "rect")
        .attr("d", valueline(data));

      // Add the X Axis
      cowChart.append("g")
        .attr("class", "xaxis")
        .attr("transform", "translate(0," + chartHeight + ")")
        .call(xAxis);

      // could put a var in .text() to make title adjust to w/e underlying data 
      cowChart.append("text")    // text label for the x axis
        .attr("x", chartWidth / 2)
        .attr("y", chartHeight + chartMargin.bottom)
        .style("text-anchor", "middle")
        .style("font-size", "25px")
        .text("State");

      // Add the Y Axis
      cowChart.append("g")
        .attr("class", "yaxis")
        .call(yAxis);

      cowChart.append("text")  // text labe for y axis
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - chartMargin.left)
        .attr("x", 0 - (chartHeight / 2))
        .attr("dy", "1em")
        .style("font-size", "20px")
        .style("text-anchor", "middle")
        .text("Value");

      // could put a var in .text() to make yaxis title adjust to w/e underlying data 
      cowChart.append("text")
        .attr("x", (chartWidth / 2))
        .attr("y", 0 - (chartMargin.top / 2))
        .attr("text-anchor", "middle")
        .style("font-size", "25px")
        .style("text-decoration", "underline")
        .text("Cows per State");

    });

    // methane map

    var title = d3.select("h1")
      .text("Methane Production by State");

    var svg = d3.select("#methaneMap")
      .append("svg")
      .attr("preserveAspectRatio", "xMinYMin meet")
      .attr("viewBox", "0 0 960 500");

    var usmap;

    var quantize = d3.scale.log()
      .domain([58201, 50203393]);

    var quantize2 = d3.scale.quantize()
      .domain([0, 1])
      .range(d3.range(8).map(function (i) { return "q" + i; }));

    var data = {};
    var polutionById2013 = d3.map();
    var polutionById2014 = d3.map();
    var polutionById2015 = d3.map();
    var polutionById2016 = d3.map();
    var polutionById2017 = d3.map();
    var stateFips = d3.map();

    var path = d3.geo.path();
    queue()
      .defer(d3.json, "us.json")
      .defer(d3.csv, "2013.csv", function (d) {
        if (typeof polutionById2013.get(d.STATE) !== 'undefined') {
          var sumdata = polutionById2013.get(d.STATE);
          sumdata += parseInt(d.VALUE);
          polutionById2013.set(d.STATE, sumdata);
        }
        else {
          polutionById2013.set(d.STATE, parseInt(d.VALUE));
        }

      })
      .defer(d3.csv, "2014.csv", function (d) {
        if (typeof polutionById2014.get(d.STATE) !== 'undefined') {
          var sumdata = polutionById2014.get(d.STATE);
          sumdata += parseInt(d.VALUE);
          polutionById2014.set(d.STATE, sumdata);
        }
        else {
          polutionById2014.set(d.STATE, parseInt(d.VALUE));
        }

      })
      .defer(d3.csv, "2015.csv", function (d) {
        if (typeof polutionById2015.get(d.STATE) !== 'undefined') {
          var sumdata = polutionById2015.get(d.STATE);
          sumdata += parseInt(d.VALUE);
          polutionById2015.set(d.STATE, sumdata);
        }
        else {
          polutionById2015.set(d.STATE, parseInt(d.VALUE));
        }

      })
      .defer(d3.csv, "2016.csv", function (d) {
        if (typeof polutionById2016.get(d.STATE) !== 'undefined') {
          var sumdata = polutionById2016.get(d.STATE);
          sumdata += parseInt(d.VALUE);
          polutionById2016.set(d.STATE, sumdata);
        }
        else
          polutionById2016.set(d.STATE, parseInt(d.VALUE));

      })
      .defer(d3.csv, "2017.csv", function (d) {
        if (typeof polutionById2017.get(d.STATE) !== 'undefined') {
          var sumdata = polutionById2017.get(d.STATE);
          sumdata += parseInt(d.VALUE);
          polutionById2017.set(d.STATE, sumdata);
        }
        else
          polutionById2017.set(d.STATE, parseInt(d.VALUE));

      })
      .defer(d3.csv, "state-fips.csv", function (d) {
        stateFips.set(d.state, d.state_abbr);
      })
      .await(ready);

    function ready(error, us) {
      if (error) throw error;
      usmap = us;
      data['2013'] = polutionById2013;
      data['2014'] = polutionById2014;
      data['2015'] = polutionById2015;
      data['2016'] = polutionById2016;
      data['2017'] = polutionById2017;
      draw('2013');

    }

    function draw(year) {
      mapping = data[year];
      svg.append("g")
        .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(usmap, usmap.objects.states).features)
        .enter().append("path")
        .attr("class", function (d) {

          sname = stateFips.get(d.id);
          var dataval = mapping.get(sname);
          return quantize2(quantize(dataval));
        })
        .attr("id", function (d) { return d.COUNTY; })
        .attr("d", path)

    }

    var slider = d3.select('#year');
    slider.on('change', function () {
      draw(this.value);
    });

    // goes to the onclick event listener of the 'update' button
    function updateData() {

      // Get the data again
      d3.csv("data2.csv", function (error, data) {
        data.forEach(function (d) {
          d.value = +d.value;
        });

        // Scale the range of the data again 
        x.domain(d3.extent(data, function (d) { return d.state; }));
        y.domain([0, d3.max(data, function (d) { return d.value; })]);

        // Select the section we want to apply our changes to
        var svg = d3.select("#cowChart").transition();

        // Make the changes 

        // put rects linked to data2 in here to build bar chart
        // or go with a line chart and use the following code..
        // svg.select(".line")   // change the line
        //   .duration(750)
        //   .attr("d", valueline(data));
        svg.select(".x.axis") // change the x axis
          .duration(750)
          .call(xAxis);
        svg.select(".y.axis") // change the y axis
          .duration(750)
          .call(yAxis);

      });
    }
  </script>